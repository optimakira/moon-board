<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2é€±é–“è¨˜éŒ²ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* åŸºæœ¬çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š */
      body {
        margin: 0;
        padding-top: 30px; /* ç”»é¢ä¸Šéƒ¨ã®ä½™ç™½ */
        font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        transition: background-color 1s ease; /* èƒŒæ™¯è‰²å¤‰æ›´ã‚’æ»‘ã‚‰ã‹ã« */
        color: #555;
        overflow-y: auto;
      }
      /* é›†ä¸­æ™‚ã¨ä¼‘æ†©æ™‚ã®èƒŒæ™¯è‰²å®šç¾© */
      .work-bg { background-color: #ccffd7; } /* ç·‘ç³» */
      .break-bg { background-color: #fff9c4; } /* é»„ç³» */

      /* ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      #timer-section {
        padding: 20px 20px 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé›†ä¸­/ä¼‘æ†©ï¼‰ã®æ–‡å­—ã‚¹ã‚¿ã‚¤ãƒ« */
      #status {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      /* ã‚¿ã‚¤ãƒãƒ¼ã®æ•°å­—ï¼šç”»é¢å¹…ã«åˆã‚ã›ã¦ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã‚‹ã‚ˆã†ã«è¨­å®š */
      #timer {
        font-size: clamp(5rem, 20vw, 10rem);
        font-weight: 200;
        font-variant-numeric: tabular-nums; /* æ•°å­—ã®å¹…ã‚’ä¸€å®šã«ã—ã¦ã‚¬ã‚¿ã¤ãã‚’é˜²ã */
        line-height: 0.9;
        margin: 20px 0;
      }
      /* ãƒœã‚¿ãƒ³é…ç½®ã®è¨­å®š */
      .btn-group {
        margin-top: 5px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      button {
        padding: 12px 25px;
        font-size: 1rem;
        cursor: pointer;
        border: 2px solid #555;
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.4);
        color: #555;
      }
      /* è¨˜éŒ²ãƒœã‚¿ãƒ³ã«ãƒ›ãƒãƒ¼ã—ãŸæ™‚ã®è‰² */
      #log-btn:hover {
        background: #55b29c;
        color: white;
        border-color: #55b29c;
      }

      /* ã‚°ãƒ©ãƒ•ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠã®å…±é€šè¨­å®š */
      #chart-container,
      #archive-chart-box {
        width: 90%;
        max-width: 800px;
        height: 320px;
        margin: 20px auto;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        box-sizing: border-box;
      }

      /* ç›´è¿‘2é€±é–“ã®ã‚°ãƒ©ãƒ•ç”¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
      #chart-container {
        padding: 20px 20px 50px 20px;
      }

      /* éå»ãƒ­ã‚°ã®ã‚°ãƒ©ãƒ•ç”¨ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
      #archive-chart-box {
        padding: 20px 20px 20px 20px;
      }

      /* æœˆ/å¹´ åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .mode-btn {
        border: none;
        background: transparent;
        padding: 5px 20px;
        border-radius: 8px;
        cursor: pointer;
        color: #777;
      }
      /* é¸æŠä¸­ã®ãƒœã‚¿ãƒ³ã‚’å¼·èª¿ */
      .mode-btn.active {
        font-weight: bold;
        background: white !important;
        color: #333;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      /* éå»ãƒ­ã‚°æ“ä½œã‚¨ãƒªã‚¢ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .archive-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }
      .select-group {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: white;
        font-size: 0.9rem;
      }
      /* æœŸé–“ç§»å‹•ã®çŸ¢å°ãƒœã‚¿ãƒ³ */
      .arrow-btn {
        border: none;
        background: #ddd;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }
    </style>
  </head>

  <body class="work-bg">
    <div id="timer-section">
      <div id="status">---</div>
      <div id="timer">00:00</div>
      <div class="btn-group">
        <button id="minus-btn">ä¸€ã¤æ¶ˆã™ â†©</button>
        <button id="log-btn">âœ¨ é›†ä¸­ã§ããŸï¼</button>
      </div>
      <p style="font-size: 0.7rem; margin-top: 10px; opacity: 0.5">
        â€»éŸ³ãŒé³´ã‚‰ãªã„å ´åˆã¯ã€ç”»é¢ã®ã©ã“ã‹ã‚’ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
      </p>
    </div>

    <div id="chart-container">
      <h2 style="text-align: center; font-size: 0.9rem; color: #777; margin-top: 0;">å®Œäº†ã‚»ãƒƒãƒˆæ•°</h2>
      <canvas id="mainChart"></canvas>
    </div>

    <hr style="width: 80%; border: 0; border-top: 1px solid #ddd; margin: 20px 0" />

    <div id="archive-section" style="width: 90%; max-width: 800px; margin-bottom: 50px">
      <h2 style="text-align: center; font-size: 1.2rem">éå»ã®è¨˜éŒ²</h2>
      <div style="display: flex; justify-content: center; margin-bottom: 20px">
        <div style="display: flex; background: rgba(0, 0, 0, 0.05); padding: 4px; border-radius: 10px;">
          <button id="btn-month" class="mode-btn active" onclick="changeMode('month')">æœˆ</button>
          <button id="btn-year" class="mode-btn" onclick="changeMode('year')">å¹´</button>
        </div>
      </div>
      <div class="archive-controls">
        <button class="arrow-btn" onclick="movePeriod(-1)">ï¼œ</button>
        <div class="select-group">
          <select id="select-year"></select>
          <select id="select-month"></select>
        </div>
        <button class="arrow-btn" onclick="movePeriod(1)">ï¼</button>
      </div>
      <div id="archive-chart-box"><canvas id="archiveChart"></canvas></div>
    </div>

    <script type="module">
      /* Firebaseé–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      /* Firebaseã®è¨­å®šæƒ…å ±ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ï¼‰ */
      const firebaseConfig = {
        apiKey: "AIzaSyBEE451bCNLV-Ty337LyZryFlZqqiN4mxo",
        authDomain: "moonboard-27ebf.firebaseapp.com",
        projectId: "moonboard-27ebf",
        storageBucket: "moonboard-27ebf.firebasestorage.app",
        messagingSenderId: "437383444283",
        appId: "1:437383444283:web:f2fab00c5e190b2ca9291e",
      };
      
      const app = initializeApp(firebaseConfig); // FirebaseåˆæœŸåŒ–
      const db = getFirestore(app); // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(Firestore)å–å¾—
      const docRef = doc(db, "data", "pomo-v1"); // ä¿å­˜å…ˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æŒ‡å®š

      /* ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° */
      let dailyData = {}, // å…¨è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        mainChart,        // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        archiveChart,     // éå»ãƒ­ã‚°ã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        archiveMode = "month"; // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ï¼ˆæœˆå˜ä½/å¹´å˜ä½ï¼‰
      let lastMode = "";  // ç›´å‰ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆé›†ä¸­/ä¼‘æ†©ï¼‰ã‚’è¨˜éŒ²ã—ã¦éŸ³ã®ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹
      const yearSel = document.getElementById("select-year");
      const monthSel = document.getElementById("select-month");

      /* --- éŸ³å£°é€šçŸ¥ã‚¨ãƒ³ã‚¸ãƒ³ã®è¨­å®š --- */
      let audioCtx = null;
      function initAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
      }
      // ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™å›é¿ã®ãŸã‚ã€æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚’æœ‰åŠ¹åŒ–
      document.body.addEventListener("click", initAudio, { once: true });

      function playSound(isWork) {
        if (!audioCtx) return;
        if (audioCtx.state === "suspended") audioCtx.resume();
        
        // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆç™ºæŒ¯å™¨ï¼‰ã§é›»å­éŸ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        const playNote = (freq, type, volume, duration) => {
          const osc = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
          g.gain.setValueAtTime(0, audioCtx.currentTime);
          g.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.05);
          g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
          osc.connect(g);
          g.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + duration);
        };

        if (isWork) {
          playNote(440, "sine", 0.1, 1.5); // é›†ä¸­é–‹å§‹éŸ³
        } else {
          playNote(880, "sine", 0.1, 0.5); // ä¼‘æ†©é–‹å§‹éŸ³ï¼ˆ2éŸ³æ§‹æˆï¼‰
          setTimeout(() => playNote(1100, "sine", 0.08, 1.0), 150);
        }
      }

      /* ã‚°ãƒ©ãƒ•ã®å…±é€šã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šé–¢æ•° */
      const getOptions = (isMain) => ({
        responsive: true,
        maintainAspectRatio: false, // ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ã«åˆã‚ã›ã‚‹
        layout: {
          padding: { left: 5, right: 15, bottom: 5 },
        },
        scales: {
          x: {
            grid: { display: true, color: "rgba(0,0,0,0.1)" },
            ticks: {
              font: { size: 10 },
              autoSkip: true, // ãƒ©ãƒ™ãƒ«ãŒé‡ãªã‚‹ã¨ãã«é–“å¼•ã
              maxRotation: 90, 
              minRotation: 45, // è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«æœ€åˆã‹ã‚‰å‚¾ã‘ã‚‹
            },
          },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(0,0,0,0.1)" },
            border: { display: true, color: "#888" },
            ticks: { stepSize: 1 }, // å®Œäº†æ•°ã¯æ•´æ•°ãªã®ã§1åˆ»ã¿ã«
          },
        },
        plugins: { legend: { display: !isMain } }, // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ•ã¯å‡¡ä¾‹ã‚’éè¡¨ç¤º
      });

      /* ãƒšãƒ¼ã‚¸èµ·å‹•æ™‚ã®åˆæœŸåŒ–å‡¦ç† */
      function init() {
        const now = new Date();
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å¹´å‰å¾Œã®é¸æŠè‚¢ã‚’è¿½åŠ 
        for (let y = now.getFullYear() - 2; y <= now.getFullYear() + 1; y++)
          yearSel.add(new Option(y + "å¹´", y));
        for (let m = 0; m < 12; m++) monthSel.add(new Option(m + 1 + "æœˆ", m));
        yearSel.value = now.getFullYear();
        monthSel.value = now.getMonth();

        // ãƒ¡ã‚¤ãƒ³ã‚°ãƒ©ãƒ•ä½œæˆ
        mainChart = new Chart(document.getElementById("mainChart"), {
          type: "bar",
          data: { labels: [], datasets: [{ data: [], backgroundColor: "#55b29c", borderRadius: 5 }] },
          options: getOptions(true),
        });
        // éå»ãƒ­ã‚°ã‚°ãƒ©ãƒ•ä½œæˆ
        archiveChart = new Chart(document.getElementById("archiveChart"), {
          type: "bar",
          data: { labels: [], datasets: [{ label: "å®Œäº†æ•°", data: [], backgroundColor: "#b2e2f2", borderRadius: 3 }] },
          options: getOptions(false),
        });

        // Firebaseã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ›´æ–°
        onSnapshot(docRef, (snap) => {
          if (snap.exists()) {
            dailyData = snap.data();
            updateAllCharts();
          }
        });
        
        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«ã‚°ãƒ©ãƒ•æ›´æ–°
        yearSel.onchange = updateArchiveChart;
        monthSel.onchange = updateArchiveChart;
      }

      /* æœˆè¡¨ç¤º/å¹´è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ */
      window.changeMode = (mode) => {
        archiveMode = mode;
        document.getElementById("btn-month").classList.toggle("active", mode === "month");
        document.getElementById("btn-year").classList.toggle("active", mode === "year");
        monthSel.style.display = mode === "year" ? "none" : "inline-block"; // å¹´ãƒ¢ãƒ¼ãƒ‰ãªã‚‰æœˆé¸æŠã‚’éš ã™
        updateArchiveChart();
      };

      /* æœŸé–“ã®å‰å¾Œç§»å‹•ãƒœã‚¿ãƒ³ã®å‡¦ç† */
      window.movePeriod = (offset) => {
        let m = parseInt(monthSel.value), y = parseInt(yearSel.value);
        if (archiveMode === "year") {
          const nextYear = y + offset;
          // é¸æŠè‚¢ã«ãªã„å¹´ã¸ç§»å‹•ã—ã‚ˆã†ã¨ã—ãŸå ´åˆã«è‡ªå‹•è¿½åŠ 
          let exists = false;
          for (let i = 0; i < yearSel.options.length; i++) {
            if (parseInt(yearSel.options[i].value) === nextYear) { exists = true; break; }
          }
          if (!exists) {
            const newOpt = new Option(nextYear + "å¹´", nextYear);
            if (offset > 0) yearSel.add(newOpt);
            else yearSel.add(newOpt, yearSel.options[0]);
          }
          yearSel.value = nextYear;
        } else {
          // æœˆå˜ä½ã®ç§»å‹•å‡¦ç†
          let d = new Date(y, m + offset, 1);
          yearSel.value = d.getFullYear();
          monthSel.value = d.getMonth();
        }
        updateArchiveChart();
      };

      /* ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°å‡¦ç†ï¼ˆå…¨ä½“ï¼‰ */
      function updateAllCharts() {
        const mLabs = [], mData = [];
        // ç›´è¿‘14æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        for (let i = 13; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
          mLabs.push(`${d.getMonth() + 1}/${d.getDate()}`);
          mData.push(dailyData[k] || 0);
        }
        mainChart.data.labels = mLabs;
        mainChart.data.datasets[0].data = mData;
        mainChart.update();
        updateArchiveChart();
      }

      /* ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚°ãƒ©ãƒ•ã®å€‹åˆ¥æ›´æ–° */
      function updateArchiveChart() {
        const y = parseInt(yearSel.value), m = parseInt(monthSel.value);
        const labels = [], data = [];
        
        if (archiveMode === "month") {
          // æœˆè¡¨ç¤ºï¼šãã®æœˆã®æ—¥æ•°åˆ†ãƒ«ãƒ¼ãƒ—
          const last = new Date(y, m + 1, 0).getDate();
          for (let d = 1; d <= last; d++) {
            labels.push(d);
            data.push(dailyData[`${y}/${m + 1}/${d}`] || 0);
          }
          archiveChart.data.datasets[0].label = `${m + 1}æœˆã®è¨˜éŒ²`;
        } else {
          // å¹´è¡¨ç¤ºï¼š12ãƒ¶æœˆåˆ†ãƒ«ãƒ¼ãƒ—
          for (let mo = 1; mo <= 12; mo++) {
            labels.push(`${mo}æœˆ`);
            let total = 0;
            for (let d = 1; d <= 31; d++) total += dailyData[`${y}/${mo}/${d}`] || 0;
            data.push(total);
          }
          archiveChart.data.datasets[0].label = `${y}å¹´ã®åˆè¨ˆ`;
        }
        archiveChart.data.labels = labels;
        archiveChart.data.datasets[0].data = data;
        archiveChart.update();
      }

      /* ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ1ç§’ã”ã¨ã«å®Ÿè¡Œï¼‰ */
      setInterval(() => {
        const now = new Date();
        // ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ã€Œ25åˆ†ã‚µã‚¤ã‚¯ãƒ«ã€ã®ã©ã“ã«ã„ã‚‹ã‹ã‚’ç®—å‡º
        // 0ã€œ19:59ã¾ã§ã¯é›†ä¸­ã€20:00ã€œ24:59ã¾ã§ã¯ä¼‘æ†©
        const cycle = (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()) % (25 * 60);
        const isWork = cycle < 20 * 60;

        const currentMode = isWork ? "work" : "break";
        if (lastMode !== "" && lastMode !== currentMode) {
          playSound(isWork); // ãƒ¢ãƒ¼ãƒ‰ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸç¬é–“ã ã‘éŸ³ã‚’é³´ã‚‰ã™
        }
        lastMode = currentMode;

        // èƒŒæ™¯è‰²ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡å­—ã®æ›´æ–°
        document.body.className = isWork ? "work-bg" : "break-bg";
        document.getElementById("status").textContent = isWork ? "âœ é›†ä¸­ã‚¿ã‚¤ãƒ " : "ğŸ¤ ã²ã¨ã‚„ã™ã¿";
        
        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®è¨ˆç®—
        let rem = isWork ? 20 * 60 - cycle : 25 * 60 - cycle;
        document.getElementById("timer").textContent = `${Math.floor(rem / 60).toString().padStart(2, "0")}:${(rem % 60).toString().padStart(2, "0")}`;
      }, 1000);

      /* ãƒœã‚¿ãƒ³æ“ä½œï¼šå®Œäº†æ•°ã‚’å¢—ã‚„ã™ */
      document.getElementById("log-btn").onclick = async () => {
        const d = new Date();
        const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        dailyData[k] = (dailyData[k] || 0) + 1;
        await setDoc(docRef, dailyData); // Firebaseã¸ä¿å­˜
      };
      
      /* ãƒœã‚¿ãƒ³æ“ä½œï¼šå®Œäº†æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆãƒŸã‚¹ä¿®æ­£ç”¨ï¼‰ */
      document.getElementById("minus-btn").onclick = async () => {
        const d = new Date();
        const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        if (dailyData[k] > 0) {
          dailyData[k] -= 1;
          await setDoc(docRef, dailyData); // Firebaseã¸ä¿å­˜
        }
      };

      init(); // å…¨ä½“ã®åˆæœŸåŒ–å®Ÿè¡Œ
    </script>
  </body>
</html>
