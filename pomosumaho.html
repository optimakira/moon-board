<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2é€±é–“è¨˜éŒ²ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        margin: 0;
        padding-top: 30px; /* â˜…ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã¨ã€ç”»é¢ã®ä¸€ç•ªä¸Šã«å¿…ãš30pxã®éš™é–“ãŒã§ãã¾ã™ */
        font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        transition: background-color 1s ease;
        color: #555;
        overflow-y: auto;
      }
      .work-bg {
        background-color: #ccffd7;
      }
      .break-bg {
        background-color: #fff9c4;
      }

      #timer-section {
        padding: 100px 20px 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #status {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 5px;
      }
      #timer {
        font-size: clamp(5rem, 20vw, 10rem);
        font-weight: 200;
        font-variant-numeric: tabular-nums;
        line-height: 0.9;
        margin: 20px 0;
      }
      .btn-group {
        margin-top: 5px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
      }
      button {
        padding: 12px 25px;
        font-size: 1rem;
        cursor: pointer;
        border: 2px solid #555;
        border-radius: 50px;
        background: rgba(255, 255, 255, 0.4);
        color: #555;
      }
      #log-btn:hover {
        background: #55b29c;
        color: white;
        border-color: #55b29c;
      }

      #chart-container,
      #archive-chart-box {
        width: 90%;
        max-width: 800px;
        height: 320px; /* â˜…ã“ã“ã§é«˜ã•ã‚’ã—ã£ã‹ã‚ŠæŒ‡å®šã—ã¾ã™ï¼ˆä¾‹ï¼š300pxï¼‰ */
        margin: 20px auto;
        background: rgba(255, 255, 255, 0.7);
        /* â˜…ã“ã“ã‚’èª¿æ•´ã—ã¾ã™ */

        border-radius: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        box-sizing: border-box; /* â˜…ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã¨paddingãŒå¹…ã«å«ã¾ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ */
      }

      /* â˜…ãƒ¡ã‚¤ãƒ³ã®ã€ŒäºŒé€±é–“ã®è¨˜éŒ²ã€å°‚ç”¨ã®ä½™ç™½ */
      #chart-container {
        padding: 20px 20px 50px 20px; /* ä¸‹ã‚’50pxã«ã—ã¦æ—¥ä»˜ã‚’ã‚†ã£ãŸã‚Šã•ã›ã‚‹ */
      }

      /* â˜…ä¸‹ã®ã€Œéå»ã®è¨˜éŒ²ã€å°‚ç”¨ã®ä½™ç™½ */
      #archive-chart-box {
        padding: 20px 20px 20px 20px; /* å…¨ä½“ã«å‡ç­‰ã«ä½™ç™½ã‚’ã¨ã‚‹ */
      }

      .mode-btn {
        border: none;
        background: transparent;
        padding: 5px 20px;
        border-radius: 8px;
        cursor: pointer;
        color: #777;
      }
      .mode-btn.active {
        font-weight: bold;
        background: white !important;
        color: #333;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .archive-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
      }
      .select-group {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
        background: white;
        font-size: 0.9rem;
      }
      .arrow-btn {
        border: none;
        background: #ddd;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }
    </style>
  </head>

  <body class="work-bg">
    <div id="timer-section">
      <div id="status">---</div>
      <div id="timer">00:00</div>
      <div class="btn-group">
        <button id="minus-btn">ä¸€ã¤æ¶ˆã™ â†©</button>
        <button id="log-btn">âœ¨ é›†ä¸­ã§ããŸï¼</button>
      </div>
      <p style="font-size: 0.7rem; margin-top: 10px; opacity: 0.5">
        â€»éŸ³ãŒé³´ã‚‰ãªã„å ´åˆã¯ã€ç”»é¢ã®ã©ã“ã‹ã‚’ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
      </p>
    </div>

    <div id="chart-container">
      <h2
        style="
          text-align: center;
          font-size: 0.9rem;
          color: #777;
          margin-top: 0;
        "
      >
        å®Œäº†ã‚»ãƒƒãƒˆæ•°
      </h2>
      <canvas id="mainChart"></canvas>
    </div>

    <hr
      style="width: 80%; border: 0; border-top: 1px solid #ddd; margin: 20px 0"
    />

    <div
      id="archive-section"
      style="width: 90%; max-width: 800px; margin-bottom: 50px"
    >
      <h2 style="text-align: center; font-size: 1.2rem">éå»ã®è¨˜éŒ²</h2>
      <div style="display: flex; justify-content: center; margin-bottom: 20px">
        <div
          style="
            display: flex;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            border-radius: 10px;
          "
        >
          <button
            id="btn-month"
            class="mode-btn active"
            onclick="changeMode('month')"
          >
            æœˆ
          </button>
          <button id="btn-year" class="mode-btn" onclick="changeMode('year')">
            å¹´
          </button>
        </div>
      </div>
      <div class="archive-controls">
        <button class="arrow-btn" onclick="movePeriod(-1)">ï¼œ</button>
        <div class="select-group">
          <select id="select-year"></select>
          <select id="select-month"></select>
        </div>
        <button class="arrow-btn" onclick="movePeriod(1)">ï¼</button>
      </div>
      <div id="archive-chart-box"><canvas id="archiveChart"></canvas></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBEE451bCNLV-Ty337LyZryFlZqqiN4mxo",
        authDomain: "moonboard-27ebf.firebaseapp.com",
        projectId: "moonboard-27ebf",
        storageBucket: "moonboard-27ebf.firebasestorage.app",
        messagingSenderId: "437383444283",
        appId: "1:437383444283:web:f2fab00c5e190b2ca9291e",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const docRef = doc(db, "data", "pomo-v1");

      let dailyData = {},
        mainChart,
        archiveChart,
        archiveMode = "month";
      let lastMode = "";
      const yearSel = document.getElementById("select-year");
      const monthSel = document.getElementById("select-month");

      // --- éŸ³ã®æº–å‚™ï¼ˆé–¢æ•°ã®å¤–ã«å‡ºã—ã¦ã©ã“ã‹ã‚‰ã§ã‚‚å‘¼ã¹ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸï¼‰ ---
      let audioCtx = null;
      function initAudio() {
        if (!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
      }
      document.body.addEventListener("click", initAudio, { once: true });

      function playSound(isWork) {
        if (!audioCtx) return;
        if (audioCtx.state === "suspended") audioCtx.resume();
        const playNote = (freq, type, volume, duration) => {
          const osc = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
          g.gain.setValueAtTime(0, audioCtx.currentTime);
          g.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + 0.05);
          g.gain.exponentialRampToValueAtTime(
            0.001,
            audioCtx.currentTime + duration,
          );
          osc.connect(g);
          g.connect(audioCtx.destination);
          osc.start();
          osc.stop(audioCtx.currentTime + duration);
        };
        if (isWork) {
          playNote(440, "sine", 0.1, 1.5); // é›†ä¸­é–‹å§‹
        } else {
          playNote(880, "sine", 0.1, 0.5); // ä¼‘æ†©é–‹å§‹
          setTimeout(() => playNote(1100, "sine", 0.08, 1.0), 150);
        }
      }

      const getOptions = (isMain) => ({
        responsive: true,
        maintainAspectRatio: false, // â˜…ã“ã‚Œã‚’è¿½åŠ ï¼ˆæ ã«åˆã‚ã›ã¦ä¼¸ã³ç¸®ã¿ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼‰
        // â˜…ã“ã“ã‹ã‚‰ã€Œlayoutã€ã‚’è¿½åŠ 
        layout: {
          padding: {
            left: 5,
            right: 15, // å³å´ã«å°‘ã—ä½™è£•ã‚’æŒãŸã›ã¦æ—¥ä»˜ã®ã¯ã¿å‡ºã—ã‚’é˜²ã
            bottom: 5,
          },
        },
        scales: {
          x: {
            grid: { display: true, color: "rgba(0,0,0,0.1)" },
            ticks: {
              font: { size: 10 },
              // â˜…ã“ã“ã‚’è¿½åŠ ï¼šãƒ©ãƒ™ãƒ«ãŒé‡ãªã‚Šãã†ãªæ™‚ã«è‡ªå‹•ã§éè¡¨ç¤ºã«ã™ã‚‹
              autoSkip: true,
              maxRotation: 0, // æ–‡å­—ã‚’æ–œã‚ã«ã—ãªã„ï¼ˆèª­ã¿ã‚„ã™ã•é‡è¦–ï¼‰
              minRotation: 0,
            },
          },

          y: {
            beginAtZero: true,
            grid: { color: "rgba(0,0,0,0.1)" },
            border: { display: true, color: "#888" },
            ticks: { stepSize: 1 },
          },
        },
        plugins: { legend: { display: !isMain } },
      });

      function init() {
        const now = new Date();
        for (let y = now.getFullYear() - 2; y <= now.getFullYear() + 1; y++)
          yearSel.add(new Option(y + "å¹´", y));
        for (let m = 0; m < 12; m++) monthSel.add(new Option(m + 1 + "æœˆ", m));
        yearSel.value = now.getFullYear();
        monthSel.value = now.getMonth();

        mainChart = new Chart(document.getElementById("mainChart"), {
          type: "bar",
          data: {
            labels: [],
            datasets: [
              { data: [], backgroundColor: "#55b29c", borderRadius: 5 },
            ],
          },
          options: getOptions(true),
        });
        archiveChart = new Chart(document.getElementById("archiveChart"), {
          type: "bar",
          data: {
            labels: [],
            datasets: [
              {
                label: "å®Œäº†æ•°",
                data: [],
                backgroundColor: "#b2e2f2",

                borderRadius: 3,
              },
            ],
          },
          options: getOptions(false),
        });

        onSnapshot(docRef, (snap) => {
          if (snap.exists()) {
            dailyData = snap.data();
            updateAllCharts();
          }
        });
        yearSel.onchange = updateArchiveChart;
        monthSel.onchange = updateArchiveChart;
      }

      window.changeMode = (mode) => {
        archiveMode = mode;
        document
          .getElementById("btn-month")
          .classList.toggle("active", mode === "month");
        document
          .getElementById("btn-year")
          .classList.toggle("active", mode === "year");
        monthSel.style.display = mode === "year" ? "none" : "inline-block";
        updateArchiveChart();
      };

      window.movePeriod = (offset) => {
        let m = parseInt(monthSel.value),
          y = parseInt(yearSel.value);

        if (archiveMode === "year") {
          const nextYear = y + offset;
          // â˜…ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼šç§»å‹•å…ˆã®å¹´ãŒã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«ãªã„å ´åˆã€æ–°ã—ãä½œã‚‹
          let exists = false;
          for (let i = 0; i < yearSel.options.length; i++) {
            if (parseInt(yearSel.options[i].value) === nextYear) {
              exists = true;
              break;
            }
          }
          if (!exists) {
            // æ˜‡é †ã«ä¸¦ã¶ã‚ˆã†ã«è¿½åŠ ï¼ˆç°¡æ˜“ç‰ˆï¼šä¸€ç•ªä¸Šã‹ä¸‹ã«è¿½åŠ ï¼‰
            const newOpt = new Option(nextYear + "å¹´", nextYear);
            if (offset > 0) yearSel.add(newOpt);
            else yearSel.add(newOpt, yearSel.options[0]);
          }
          yearSel.value = nextYear;
        } else {
          let d = new Date(y, m + offset, 1);
          yearSel.value = d.getFullYear();
          monthSel.value = d.getMonth();
        }
        updateArchiveChart();
      };

      function updateAllCharts() {
        const mLabs = [],
          mData = [];
        for (let i = 13; i >= 0; i--) {
          const d = new Date();
          d.setDate(d.getDate() - i);
          const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
          mLabs.push(`${d.getMonth() + 1}/${d.getDate()}`);
          mData.push(dailyData[k] || 0);
        }
        mainChart.data.labels = mLabs;
        mainChart.data.datasets[0].data = mData;
        mainChart.update();
        updateArchiveChart();
      }

      function updateArchiveChart() {
        const y = parseInt(yearSel.value),
          m = parseInt(monthSel.value);
        const labels = [],
          data = [];
        if (archiveMode === "month") {
          const last = new Date(y, m + 1, 0).getDate();
          for (let d = 1; d <= last; d++) {
            labels.push(d);
            data.push(dailyData[`${y}/${m + 1}/${d}`] || 0);
          }
          archiveChart.data.datasets[0].label = `${m + 1}æœˆã®è¨˜éŒ²`;
        } else {
          for (let mo = 1; mo <= 12; mo++) {
            labels.push(`${mo}æœˆ`);
            let total = 0;
            for (let d = 1; d <= 31; d++)
              total += dailyData[`${y}/${mo}/${d}`] || 0;
            data.push(total);
          }
          archiveChart.data.datasets[0].label = `${y}å¹´ã®åˆè¨ˆ`;
        }
        archiveChart.data.labels = labels;
        archiveChart.data.datasets[0].data = data;
        archiveChart.update();
      }

      // ã‚¿ã‚¤ãƒãƒ¼
      setInterval(() => {
        const now = new Date();
        const cycle =
          (now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds()) %
          (25 * 60);
        const isWork = cycle < 20 * 60;

        const currentMode = isWork ? "work" : "break";
        if (lastMode !== "" && lastMode !== currentMode) {
          playSound(isWork); // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿æ™‚ã«éŸ³ã‚’é³´ã‚‰ã™
        }
        lastMode = currentMode;

        document.body.className = isWork ? "work-bg" : "break-bg";
        document.getElementById("status").textContent = isWork
          ? "âœ é›†ä¸­ã‚¿ã‚¤ãƒ "
          : "ğŸ¤ ã²ã¨ã‚„ã™ã¿";
        let rem = isWork ? 20 * 60 - cycle : 25 * 60 - cycle;
        document.getElementById("timer").textContent = `${Math.floor(rem / 60)
          .toString()
          .padStart(2, "0")}:${(rem % 60).toString().padStart(2, "0")}`;
      }, 1000);

      document.getElementById("log-btn").onclick = async () => {
        const d = new Date();
        const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        dailyData[k] = (dailyData[k] || 0) + 1;
        await setDoc(docRef, dailyData);
      };
      document.getElementById("minus-btn").onclick = async () => {
        const d = new Date();
        const k = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
        if (dailyData[k] > 0) {
          dailyData[k] -= 1;
          await setDoc(docRef, dailyData);
        }
      };

      init();
    </script>
  </body>
</html>
